name: Random Capsule Gradient

on:
  workflow_dispatch:
  schedule:
    - cron: '30 0 * * *'

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Update gradient
      run: |
        # 读取配置文件
        config=$(cat config.json)
        colors=$(echo $config | python3 -c "import json,sys;data=json.load(sys.stdin);print(' '.join(data['gradient']['candidate_colors']))")
        count=$(echo $config | python3 -c "import json,sys;data=json.load(sys.stdin);print(data['gradient']['count'])")
        saturation=$(echo $config | python3 -c "import json,sys;data=json.load(sys.stdin);print(data['gradient']['saturation'])")
        
        # 随机选择颜色
        selected_colors=$(echo $colors | python3 -c "
        import random, sys
        colors = sys.stdin.read().split()
        random.shuffle(colors)
        print(' '.join(colors[:$count]))
        ")
        
        # 调整颜色饱和度
        adjusted_colors=$(python3 adjust_colors.py "$selected_colors" $saturation)
        
        # 构建渐变参数
        color_param=""
        IFS=' ' read -ra color_array <<< "$adjusted_colors"
        for i in "${!color_array[@]}"; do
          position=$((i * 100 / (${#color_array[@]} - 1)))
          color_param+="${position}:${color_array[i]#\#},"
        done
        color_param=${color_param%,}
        
        # 生成新的URL
        timestamp=$(date +%s)
        new_header_url="https://capsule-render.vercel.app/api?type=waving&height=200&section=header&fontSize=40&fontAlignY=35&text=👋%20Hi%20I'm%20BlueSeagull&desc=Welcome%20to%20my%20GitHub&descAlignY=55&color=$color_param&t=$timestamp"
        new_footer_url="https://capsule-render.vercel.app/api?type=waving&height=100&section=footer&color=$color_param&t=$timestamp"
        
        # 读取README内容
        content=$(cat README.md)
        
        # 替换URL（使用字符串替换而不是正则表达式）
        content="${content//https://capsule-render.vercel.app/api?type=waving&height=200&section=header*alt=\"header\"/$new_header_url\" alt=\"header\"}"
        content="${content//https://capsule-render.vercel.app/api?type=waving&height=100&section=footer*alt=\"footer\"/$new_footer_url\" alt=\"footer\"}"
        
        # 写回README
        echo "$content" > README.md

    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        git diff --staged --quiet || git commit -m "🎨 Update gradient colors"
        git pull --rebase
        git push
