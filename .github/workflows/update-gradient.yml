name: Update Gradient

on:
  workflow_dispatch:
  schedule:
    - cron: '30 0 * * *'

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Update gradient colors
      run: |
        # è¯»å–é…ç½®æ–‡ä»¶
        config=$(cat config.json)
        colors=$(echo $config | python3 -c "import json,sys;data=json.load(sys.stdin);print(' '.join(data['gradient']['candidate_colors']))")
        count=$(echo $config | python3 -c "import json,sys;data=json.load(sys.stdin);print(data['gradient']['count'])")
        saturation=$(echo $config | python3 -c "import json,sys;data=json.load(sys.stdin);print(data['gradient']['saturation'])")
        
        # éšæœºé€‰æ‹©é¢œè‰²
        selected_colors=$(echo $colors | python3 -c "
        import random, sys
        colors = sys.stdin.read().split()
        random.shuffle(colors)
        print(' '.join(colors[:$count]))
        ")
        
        echo "Selected colors: $selected_colors"
        
        # è°ƒæ•´é¢œè‰²é¥±å’Œåº¦
        adjusted_colors=$(python3 adjust_colors.py "$selected_colors" $saturation)
        echo "Adjusted colors: $adjusted_colors"
        
        # æ„å»ºæ¸å˜å‚æ•°
        color_param=""
        IFS=' ' read -ra color_array <<< "$adjusted_colors"
        for i in "${!color_array[@]}"; do
          position=$((i * 100 / (${#color_array[@]} - 1)))
          color_param+="${position}:${color_array[i]#\#},"
        done
        color_param=${color_param%,}
        
        # ç”Ÿæˆæ—¶é—´æˆ³
        timestamp=$(date +%s)
        
        # ç”Ÿæˆæ–°çš„URL
        new_header_url="https://capsule-render.vercel.app/api?type=waving&height=200&section=header&fontSize=40&fontAlignY=35&text=ğŸ‘‹%20Hi%20I'm%20BlueSeagull&desc=Welcome%20to%20my%20GitHub&descAlignY=55&color=$color_param&t=$timestamp"
        new_footer_url="https://capsule-render.vercel.app/api?type=waving&height=100&section=footer&color=$color_param&t=$timestamp"
        
        echo "New Header URL: $new_header_url"
        echo "New Footer URL: $new_footer_url"
        
        # æ›´æ–°README - ä½¿ç”¨ç®€å•çš„æ›¿æ¢æ–¹æ³•
        sed -i "s|https://capsule-render\.vercel\.app/api?[^\"]*section=header[^\"]*|$new_header_url|g" README.md
        sed -i "s|https://capsule-render\.vercel\.app/api?[^\"]*section=footer[^\"]*|$new_footer_url|g" README.md
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --quiet; then
          echo "No changes to commit"
        else
          git add README.md
          git commit -m "ğŸ¨ Update gradient colors [auto]"
          git push
        fi
