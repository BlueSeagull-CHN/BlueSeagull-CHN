name: ğŸ¨ Random Capsule Gradient

on:
  push:
    branches: [ main ]          # æ¨é€è‡³ main åˆ†æ”¯è§¦å‘å·¥ä½œæµç¨‹
  schedule:
    - cron: '30 0 * * *'       # æ¯å¤© 00:30 UTCï¼ˆHKT 08:30ï¼‰è§¦å‘ï¼Œéœ€æ ¹æ® config.json çš„ gradient.schedule æ‰‹åŠ¨è°ƒæ•´
  workflow_dispatch:            # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write               # æˆäºˆå†™ä»“åº“æƒé™ä»¥æ›´æ–° README å’Œå¤‡ä»½æ–‡ä»¶

jobs:
  gradient:
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºä»£ç åº“ï¼ŒåŒ…æ‹¬ .github/scripts
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0          # æ‹‰å–å®Œæ•´å†å²ä»¥é¿å…å†²çª
          token: ${{ secrets.GITHUB_TOKEN }}

      # å¤‡ä»½ README.mdï¼Œé˜²æ­¢åŠ¨æ€æ›´æ–°è¦†ç›–
      - name: Backup README.md
        run: |
          if [ -f README.md ]; then
            cp README.md README-backup.md
            git add README-backup.md
            git commit -m "å¤‡ä»½ README.md åœ¨æ›´æ–°å‰" || true
            echo "å·²å¤‡ä»½ README.md è‡³ README-backup.md"
          else
            echo "æœªæ‰¾åˆ° README.mdï¼Œè·³è¿‡å¤‡ä»½"
          fi

      # å®‰è£… jq å’Œ Pythonï¼ˆç”¨äºè¯»å– config.json å’Œè°ƒæ•´é¢œè‰²ï¼‰
      - name: Install jq and Python
        run: |
          sudo apt-get update
          sudo apt-get install -y jq python3

      # æ£€æŸ¥ config.json æ˜¯å¦å­˜åœ¨ï¼Œè‹¥æ— åˆ™åˆ›å»ºé»˜è®¤é…ç½®
      - name: Check config.json existence
        run: |
          if [ ! -f config.json ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° config.jsonï¼Œåˆ›å»ºé»˜è®¤é…ç½®"
            echo '{
              "header": {"text": "ğŸ‘‹ Hi, I'\''m BlueSeagull", "desc": "Welcome to my GitHub"},
              "footer": {"text": "", "desc": ""},
              "intro": {"text": "ğŸš€ å–œæ¬¢å†™ä»£ç ã€è¯»ä¹¦ã€æŠ˜è…¾æ–°æŠ€æœ¯"},
              "gradient": {
                "colors": [
                  "#A3BFFA", "#AED9E0", "#B9E4C9", "#C1E1C1", "#D4F1F4",
                  "#E0F7FA", "#F8C8DC", "#F5E1E6", "#FAD2CF", "#E6E6FA",
                  "#F0E4D7", "#D8D8F0"
                ],
                "count": 5,
                "saturation": 1.0,
                "schedule": "24:30"
              }
            }' > config.json
            git add config.json
            git commit -m "æ·»åŠ é»˜è®¤ config.json" || true
          fi

      # è¯»å– config.json çš„æ–‡å­—å’Œæ¸å˜è®¾ç½®
      - name: Read config.json
        id: read_config
        run: |
          # è¯»å– headerã€introã€footer æ–‡å­—
          header_text=$(jq -r '.header.text' config.json)
          header_desc=$(jq -r '.header.desc' config.json)
          footer_text=$(jq -r '.footer.text' config.json)
          footer_desc=$(jq -r '.footer.desc' config.json)
          intro_text=$(jq -r '.intro.text // "ğŸš€ å–œæ¬¢å†™ä»£ç ã€è¯»ä¹¦ã€æŠ˜è…¾æ–°æŠ€æœ¯"' config.json)
          # URL ç¼–ç ï¼ˆç”¨äº capsule-render å‚æ•°ï¼‰
          header_text_encoded=$(echo -n "$header_text" | python3 -c "import urllib.parse, sys; print(urllib.parse.quote(sys.stdin.read()))")
          header_desc_encoded=$(echo -n "$header_desc" | python3 -c "import urllib.parse, sys; print(urllib.parse.quote(sys.stdin.read()))")
          footer_text_encoded=$(echo -n "$footer_text" | python3 -c "import urllib.parse, sys; print(urllib.parse.quote(sys.stdin.read()))")
          footer_desc_encoded=$(echo -n "$footer_desc" | python3 -c "import urllib.parse, sys; print(urllib.parse.quote(sys.stdin.read()))")
          # è¯»å–æ¸å˜è®¾ç½®
          colors=$(jq -r '.gradient.colors // ["#A3BFFA", "#AED9E0", "#B9E4C9", "#C1E1C1", "#D4F1F4", "#E0F7FA", "#F8C8DC", "#F5E1E6", "#FAD2CF", "#E6E6FA", "#F0E4D7", "#D8D8F0"] | join(" ")' config.json)
          count=$(jq -r '.gradient.count // 5' config.json)
          saturation=$(jq -r '.gradient.saturation // 1.0' config.json)
          schedule=$(jq -r '.gradient.schedule // "24:30"' config.json)
          # è¾“å‡ºåˆ°åç»­æ­¥éª¤
          echo "header_text_encoded=$header_text_encoded" >> $GITHUB_OUTPUT
          echo "header_desc_encoded=$header_desc_encoded" >> $GITHUB_OUTPUT
          echo "footer_text_encoded=$footer_text_encoded" >> $GITHUB_OUTPUT
          echo "footer_desc_encoded=$footer_desc_encoded" >> $GITHUB_OUTPUT
          echo "intro_text=$intro_text" >> $GITHUB_OUTPUT
          echo "colors=$colors" >> $GITHUB_OUTPUT
          echo "count=$count" >> $GITHUB_OUTPUT
          echo "saturation=$saturation" >> $GITHUB_OUTPUT
          echo "schedule=$schedule" >> $GITHUB_OUTPUT
          echo "è¯»å– header_text: $header_text"
          echo "è¯»å– header_desc: $header_desc"
          echo "è¯»å– intro_text: $intro_text"
          echo "è¯»å– gradient.colors: $colors"
          echo "è¯»å– gradient.count: $count"
          echo "è¯»å– gradient.saturation: $saturation"
          echo "è¯»å– gradient.schedule: $schedule"

      # éªŒè¯æ¸å˜è®¾ç½®å¹¶è°ƒæ•´é¥±å’Œåº¦
      - name: Validate and adjust colors
        id: adjust_colors
        run: |
          colors="${{ steps.read_config.outputs.colors }}"
          count="${{ steps.read_config.outputs.count }}"
          saturation="${{ steps.read_config.outputs.saturation }}"
          # éªŒè¯ countï¼ˆ2-5ï¼‰
          if ! [[ "$count" =~ ^[2-5]$ ]]; then
            echo "é”™è¯¯ï¼šgradient.count å¿…é¡»åœ¨ 2-5 ä¹‹é—´ï¼Œä½¿ç”¨é»˜è®¤å€¼ 5"
            count=5
          fi
          # éªŒè¯ saturationï¼ˆ0.5-2.0ï¼‰
          if ! echo "$saturation" | grep -qE '^[0-1]\.[0-9]{1,2}$|^2\.0$'; then
            echo "é”™è¯¯ï¼šgradient.saturation å¿…é¡»åœ¨ 0.5-2.0 ä¹‹é—´ï¼Œä½¿ç”¨é»˜è®¤å€¼ 1.0"
            saturation=1.0
          fi
          # éªŒè¯é¢œè‰²æ ¼å¼ï¼ˆHEXï¼‰
          valid_colors=()
          for color in $colors; do
            if [[ "$color" =~ ^#[0-9A-Fa-f]{6}$ ]]; then
              valid_colors+=("$color")
            else
              echo "è­¦å‘Šï¼šæ— æ•ˆé¢œè‰² $colorï¼Œè·³è¿‡"
            fi
          done
          # è‹¥æœ‰æ•ˆé¢œè‰²ä¸è¶³ countï¼Œä»é»˜è®¤æ± è¡¥é½
          default_colors=("A3BFFA" "AED9E0" "B9E4C9" "C1E1C1" "D4F1F4" "E0F7FA" "F8C8DC" "F5E1E6" "FAD2CF" "E6E6FA" "F0E4D7" "D8D8F0")
          while [ ${#valid_colors[@]} -lt $count ]; do
            valid_colors+=("${default_colors[$((RANDOM % ${#default_colors[@]}))]}")
          done
          # è°ƒæ•´é¥±å’Œåº¦ï¼ˆè°ƒç”¨å¤–éƒ¨ Python è„šæœ¬ï¼‰
          adjusted_colors=$(python3 .github/scripts/adjust_colors.py "${valid_colors[*]}" "$saturation")
          # éšæœºé€‰æ‹© count ä¸ªé¢œè‰²
          selected_colors=($(echo "$adjusted_colors" | shuf -n $count))
          # ç”Ÿæˆ capsule-render æ ¼å¼ï¼š0:hex1,20:hex2,...,100:hexN
          capsule_color=""
          if [ $count -eq 1 ]; then
            capsule_color="0:${selected_colors[0]}"
          else
            step=$(echo "scale=2; 100 / ($count - 1)" | bc)
            for i in "${!selected_colors[@]}"; do
              percentage=$(echo "scale=0; $i * $step / 1" | bc)
              capsule_color+="$percentage:${selected_colors[$i]}"
              [ $i -lt $((count-1)) ] && capsule_color+=","
            done
          fi
          # ç”Ÿæˆ github-readme-stats æ ¼å¼ï¼š0,hex1,hex2,...,hexN
          stats_color="0"
          for color in "${selected_colors[@]}"; do
            stats_color+=",${color#\#}"
          done
          # è¾“å‡ºåˆ°åç»­æ­¥éª¤
          echo "capsule_color=$capsule_color" >> $GITHUB_OUTPUT
          echo "stats_color=$stats_color" >> $GITHUB_OUTPUT
          echo "è°ƒæ•´åçš„é¢œè‰²: ${selected_colors[*]}"
          echo "ç”Ÿæˆçš„ capsule_color: $capsule_color"
          echo "ç”Ÿæˆçš„ stats_color: $stats_color"

      # è§£æåˆ·æ–°é¢‘ç‡å¹¶æç¤º cron è¡¨è¾¾å¼
      - name: Parse schedule
        id: parse_schedule
        run: |
          schedule="${{ steps.read_config.outputs.schedule }}"
          cron=""
          case "$schedule" in
            "daily")
              cron="0 0 * * *"
              ;;
            "weekly")
              cron="0 0 * * 0"
              ;;
            "monthly")
              cron="0 0 1 * *"
              ;;
            *[0-2][0-9]:[0-5][0-9]*)
              hour=$(echo "$schedule" | cut -d':' -f1)
              minute=$(echo "$schedule" | cut -d':' -f2)
              # å¤„ç† 24:XX ä¸ºæ¬¡æ—¥ 00:XX
              if [ "$hour" = "24" ]; then
                hour="0"
              fi
              if [[ "$hour" =~ ^[0-2][0-9]$ && "$minute" =~ ^[0-5][0-9]$ ]]; then
                cron="$minute $hour * * *"
              else
                echo "é”™è¯¯ï¼šæ— æ•ˆæ—¶é—´æ ¼å¼ $scheduleï¼Œä½¿ç”¨é»˜è®¤ daily (0 0 * * *)"
                cron="0 0 * * *"
              fi
              ;;
            *)
              echo "é”™è¯¯ï¼šæ— æ•ˆ schedule æ ¼å¼ $scheduleï¼Œä½¿ç”¨é»˜è®¤ daily (0 0 * * *)"
              cron="0 0 * * *"
              ;;
          esac
          echo "è§£æçš„ cron è¡¨è¾¾å¼: $cron"
          echo "è¯·æ‰‹åŠ¨æ›´æ–° Random-color.yml çš„ on.schedule.cron ä¸º '$cron'"
          echo "cron=$cron" >> $GITHUB_OUTPUT

      # æ›´æ–° README.md çš„æ¸å˜å’Œæ–‡å­—
      - name: Update README with gradients and text
        run: |
          # è·å–å˜é‡
          capsule_color="${{ steps.adjust_colors.outputs.capsule_color }}"
          stats_color="${{ steps.adjust_colors.outputs.stats_color }}"
          header_text_encoded="${{ steps.read_config.outputs.header_text_encoded }}"
          header_desc_encoded="${{ steps.read_config.outputs.header_desc_encoded }}"
          footer_text_encoded="${{ steps.read_config.outputs.footer_text_encoded }}"
          footer_desc_encoded="${{ steps.read_config.outputs.footer_desc_encoded }}"
          intro_text="${{ steps.read_config.outputs.intro_text }}"

          # å®šä¹‰æ›¿æ¢å—
          header_block="<!-- capsulate-header-start -->\n<p>\n  <img src=\"https://capsule-render.vercel.app/api?type=waving&height=200&section=header&fontSize=40&fontAlignY=35&text=${header_text_encoded}&desc=${header_desc_encoded}&descAlignY=55&color=${capsule_color}\" alt=\"header\"/>\n</p>\n<!-- capsulate-header-end -->"

          intro_block="<!-- intro-start -->\n<h3>\n  ${intro_text}\n</h3>\n<!-- intro-end -->"

          footer_block="<!-- capsulate-footer-start -->\n<p>\n  <img src=\"https://capsule-render.vercel.app/api?type=waving&height=100&section=footer&color=${capsule_color}\" alt=\"footer\"/>\n</p>\n<!-- capsulate-footer-end -->"

          stats_block="<!-- github-stats-start -->\n<p>\n  <img height=\"160\" src=\"https://github-readme-stats-bay.vercel.app/api?username=BlueSeagull-CHN&hide_title=true&hide_border=true&show_icons=true&include_all_commits=true&line_height=21&bg_color=${stats_color}&theme=graywhite\" alt=\"stats\"/>\n</p>\n<!-- github-stats-end -->"

          # ä½¿ç”¨ Perl æ›¿æ¢ï¼Œä»…æ›´æ–°åŠ¨æ€éƒ¨åˆ†
          perl -0777 -pe "
            s|<!-- capsulate-header-start -->.*?<!-- capsulate-header-end -->|$header_block|s;
            s|<!-- intro-start -->.*?<!-- intro-end -->|$intro_block|s;
            s|<!-- capsulate-footer-start -->.*?<!-- capsulate-footer-end -->|$footer_block|s;
            s|<!-- github-stats-start -->.*?<!-- github-stats-end -->|$stats_block|s;
          " -i README.md

      # æäº¤æ›´æ”¹
      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md README-backup.md config.json .github/scripts/adjust_colors.py
          if ! git diff --quiet || ! git diff --staged --quiet; then
            git commit -m "ğŸ¨ æ›´æ–°æ¸å˜é¢œè‰²ã€æ–‡å­—å’Œå¤‡ä»½ README"
            git push || {
              echo "æ¨é€å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶æ¨é€"
              git push --force
            }
          else
            echo "æ— æ›´æ”¹éœ€è¦æäº¤"
          fi
