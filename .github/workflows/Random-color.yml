name: ğŸ¨ Random Capsule Gradient

on:
  push:
    branches: [ main ]          # æ¯æ¬¡æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  schedule:
    - cron: '0 0 * * *'         # æ¯å¤© 00:00 UTC è§¦å‘ä¸€æ¬¡
  workflow_dispatch:            # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write               # æˆäºˆå†™ä»“åº“æƒé™ä»¥æ›´æ–° README

jobs:
  gradient:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3  # æ£€å‡ºä»£ç åº“
        with:
          fetch-depth: 0          # æ‹‰å–å®Œæ•´å†å²ä»¥é¿å…å†²çª
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq  # å®‰è£… jq ç”¨äºè§£æ JSON

      - name: Check config.json existence
        run: |
          if [ ! -f config.json ]; then
            echo "Error: config.json not found. Creating default config.json."
            echo '{
              "header": {"text": "ğŸ‘‹ Hi, I'\''m BlueSeagull", "desc": "Welcome to my GitHub"},
              "footer": {"text": "", "desc": ""},
              "intro": {"text": "ğŸš€ å–œæ¬¢å†™ä»£ç ã€è¯»ä¹¦ã€æŠ˜è…¾æ–°æŠ€æœ¯"}
            }' > config.json
            git add config.json
            git commit -m "Add default config.json" || true
          fi

      - name: Read text from config.json
        id: read_config
        run: |
          # è¯»å– config.json ä¸­çš„æ–‡å­—
          header_text=$(jq -r '.header.text' config.json)
          header_desc=$(jq -r '.header.desc' config.json)
          footer_text=$(jq -r '.footer.text' config.json)
          footer_desc=$(jq -r '.footer.desc' config.json)
          intro_text=$(jq -r '.intro.text // "ğŸš€ å–œæ¬¢å†™ä»£ç ã€è¯»ä¹¦ã€æŠ˜è…¾æ–°æŠ€æœ¯"' config.json)
          # URL ç¼–ç ï¼ˆä»…å¯¹ capsule-render çš„å‚æ•°ï¼‰
          header_text_encoded=$(echo -n "$header_text" | python3 -c "import urllib.parse, sys; print(urllib.parse.quote(sys.stdin.read()))")
          header_desc_encoded=$(echo -n "$header_desc" | python3 -c "import urllib.parse, sys; print(urllib.parse.quote(sys.stdin.read()))")
          footer_text_encoded=$(echo -n "$footer_text" | python3 -c "import urllib.parse, sys; print(urllib.parse.quote(sys.stdin.read()))")
          footer_desc_encoded=$(echo -n "$footer_desc" | python3 -c "import urllib.parse, sys; print(urllib.parse.quote(sys.stdin.read()))")
          # è¾“å‡ºåˆ°åç»­æ­¥éª¤
          echo "header_text_encoded=$header_text_encoded" >> $GITHUB_OUTPUT
          echo "header_desc_encoded=$header_desc_encoded" >> $GITHUB_OUTPUT
          echo "footer_text_encoded=$footer_text_encoded" >> $GITHUB_OUTPUT
          echo "footer_desc_encoded=$footer_desc_encoded" >> $GITHUB_OUTPUT
          echo "intro_text=$intro_text" >> $GITHUB_OUTPUT
          echo "Read header_text: $header_text"
          echo "Read header_desc: $header_desc"
          echo "Read intro_text: $intro_text"

      - name: Generate random gradient colors
        id: generate_colors
        run: |
          # æ¸…æ–°æ·¡é›…çš„é¢œè‰²æ± 
          colors=(
            "A3BFFA"  # æµ…ç´«è“
            "AED9E0"  # æ¹–è“
            "B9E4C9"  # è–„è·ç»¿
            "C1E1C1"  # æ·¡ç»¿
            "D4F1F4"  # æ°´è“
            "E0F7FA"  # æµ…é’
            "F8C8DC"  # æ¨±èŠ±ç²‰
            "F5E1E6"  # æ·¡ç²‰
            "FAD2CF"  # èœœæ¡ƒç²‰
            "E6E6FA"  # è–°è¡£è‰ç´«
            "F0E4D7"  # ç±³ç™½
            "D8D8F0"  # æ·¡ç´«
          )
          # éšæœºæŒ‘é€‰ 4 ä¸ªé¢œè‰²
          selected_colors=($(shuf -n 4 -e "${colors[@]}"))
          # capsule-render æ ¼å¼: 0:hex1,33:hex2,66:hex3,100:hex4
          capsule_color="0:${selected_colors[0]},33:${selected_colors[1]},66:${selected_colors[2]},100:${selected_colors[3]}"
          # github-readme-stats æ ¼å¼: angle,hex1,hex2,hex3,hex4
          stats_color="0,${selected_colors[0]},${selected_colors[1]},${selected_colors[2]},${selected_colors[3]}"
          # è¾“å‡ºåˆ°åç»­æ­¥éª¤
          echo "capsule_color=$capsule_color" >> $GITHUB_OUTPUT
          echo "stats_color=$stats_color" >> $GITHUB_OUTPUT
          echo "Generated capsule_color: $capsule_color"
          echo "Generated stats_color: $stats_color"

      - name: Fetch external README
        id: fetch_external
        run: |
          if ! curl -s -f https://raw.githubusercontent.com/BlueSeagull-CHN/PersonalConfiguration/refs/heads/main/README.md > external_readme.md; then
            echo "Failed to fetch external README, using fallback content"
            echo "<p>Unable to load external resources</p>" > external_readme.md
          fi
          # è°ƒæ•´æ ‡é¢˜å±‚çº§ï¼ˆ# -> ###, ## -> ####ï¼‰ï¼Œæ›¿æ¢ --- ä¸º <hr>
          external_content=$(cat external_readme.md | perl -pe 's/^# /### /; s/^## /#### /; s/^---\n/<hr style="border: 1px solid #F8C8DC; margin: 20px 0;">\n/')
          # è½¬ä¹‰æ¢è¡Œç¬¦å’ŒåŒå¼•å·
          external_content=$(echo "$external_content" | perl -pe 's/\n/\\n/g; s/"/\\"/g')
          echo "external_content=$external_content" >> $GITHUB_OUTPUT

      - name: Update README with gradients, text, and external content
        run: |
          # è·å–å˜é‡
          capsule_color="${{ steps.generate_colors.outputs.capsule_color }}"
          stats_color="${{ steps.generate_colors.outputs.stats_color }}"
          header_text_encoded="${{ steps.read_config.outputs.header_text_encoded }}"
          header_desc_encoded="${{ steps.read_config.outputs.header_desc_encoded }}"
          footer_text_encoded="${{ steps.read_config.outputs.footer_text_encoded }}"
          footer_desc_encoded="${{ steps.read_config.outputs.footer_desc_encoded }}"
          intro_text="${{ steps.read_config.outputs.intro_text }}"
          external_content="${{ steps.fetch_external.outputs.external_content }}"

          # å®šä¹‰å—
          header_block="<!-- capsulate-header-start -->\n<p>\n  <img src=\"https://capsule-render.vercel.app/api?type=waving&height=200&section=header&fontSize=40&fontAlignY=35&text=${header_text_encoded}&desc=${header_desc_encoded}&descAlignY=55&color=${capsule_color}\" alt=\"header\"/>\n</p>\n<!-- capsulate-header-end -->"

          intro_block="<!-- intro-start -->\n<h3>\n  ${intro_text}\n</h3>\n<!-- intro-end -->"

          external_block="<!-- external-start -->\n<h4>ğŸ“š External Resources</h4>\n${external_content}\n<!-- external-end -->"

          footer_block="<!-- capsulate-footer-start -->\n<p>\n  <img src=\"https://capsule-render.vercel.app/api?type=waving&height=100&section=footer&color=${capsule_color}\" alt=\"footer\"/>\n</p>\n<!-- capsulate-footer-end -->"

          stats_block="<!-- github-stats-start -->\n<p>\n  <img height=\"160\" src=\"https://github-readme-stats-bay.vercel.app/api?username=BlueSeagull-CHN&hide_title=true&hide_border=true&show_icons=true&include_all_commits=true&line_height=21&bg_color=${stats_color}&theme=graywhite\" alt=\"stats\"/>\n</p>\n<!-- github-stats-end -->"

          # ä½¿ç”¨ Perl æ›¿æ¢
          perl -0777 -pe "
            s|<!-- capsulate-header-start -->.*?<!-- capsulate-header-end -->|$header_block|s;
            s|<!-- intro-start -->.*?<!-- intro-end -->|$intro_block|s;
            s|<!-- external-start -->.*?<!-- external-end -->|$external_block|s;
            s|<!-- capsulate-footer-start -->.*?<!-- capsulate-footer-end -->|$footer_block|s;
            s|<!-- github-stats-start -->.*?<!-- github-stats-end -->|$stats_block|s;
          " -i README.md

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md config.json
          if ! git diff --quiet || ! git diff --staged --quiet; then
            git commit -m "ğŸ¨ chore: update capsule, stats gradients, intro text, and external content"
            git push || {
              echo "Push failed, attempting force push"
              git push --force
            }
          else
            echo "No changes to commit"
          fi
