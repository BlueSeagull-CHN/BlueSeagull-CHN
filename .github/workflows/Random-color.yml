name: 🎨 Random Capsule Gradient

on:
  push:
    branches: [ main ]          # 每次推送到 main 分支时触发
  schedule:
    - cron: '0 0 * * *'         # 每天 00:00 UTC 触发一次
  workflow_dispatch:            # 支持手动触发

permissions:
  contents: write               # 授予写仓库权限以更新 README

jobs:
  gradient:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3  # 检出代码库

      - name: Random pick gradient & update README
        run: |
          # 清新淡雅的颜色池，随机挑选 4 种组成渐变
          colors=(
            "A3BFFA"  # 浅紫蓝
            "AED9E0"  # 湖蓝
            "B9E4C9"  # 薄荷绿
            "C1E1C1"  # 淡绿
            "D4F1F4"  # 水蓝
            "E0F7FA"  # 浅青
            "F8C8DC"  # 樱花粉
            "F5E1E6"  # 淡粉
            "FAD2CF"  # 蜜桃粉
            "E6E6FA"  # 薰衣草紫
            "F0E4D7"  # 米白
            "D8D8F0"  # 淡紫
          )
          # 随机挑选 4 个颜色
          selected_colors=($(shuf -n 4 -e "${colors[@]}"))
          color="0:${selected_colors[0]},33:${selected_colors[1]},66:${selected_colors[2]},100:${selected_colors[3]}"

          header_block="<!-- capsulate-header-start -->\n<p align=\"center\">\n  <img src=\"https://capsule-render.vercel.app/api?type=waving&height=200&section=header&fontSize=40&fontAlignY=35&text=👋%20Hi%2C%20I%27m%20BlueSeagull&desc=Welcome%20to%20my%20GitHub&descAlignY=55&color=${color}\" alt=\"header\"/>\n</p>\n<!-- capsulate-header-end-->"

          footer_block="<!-- capsulate-footer-start -->\n<p align=\"center\">\n  <img src=\"https://capsule-render.vercel.app/api?type=waving&height=100&section=footer&color=${color}\" alt=\"footer\"/>\n</p>\n<!-- capsulate-footer-end-->"

          # 使用 Perl 替换 README.md 中的 header 和 footer 部分
          perl -0777 -pe "
            s|<!-- capsulate-header-start -->.*?<!-- capsulate-header-end-->|$header_block|s;
            s|<!-- capsulate-footer-start -->.*?<!-- capsulate-footer-end-->|$footer_block|s;
          " -i README.md

          # 调试：输出生成的颜色值
          echo "Generated color: $color"

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (
            git commit -m "🎨 chore: update capsule gradient"
            git push
          )
